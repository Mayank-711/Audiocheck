{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="dashboard">
    <h1>Dashboard</h1>
    
    <li><a href="{% url 'logout' %}">Logout</a></li>

    <div class="upload-section">
        <h2>Upload Audio File</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Upload</button>
        </form>
    </div>

    <div class="audio-list">
        <h2>Uploaded Audio Files</h2>

        {% if audio_files %}
        <table border="1">
            <thead>
                <tr>
                    <th>#</th>
                    <th>File Name</th>
                    <th>Play</th>
                    <th>Actions</th>
                    <th>Analysis</th>
                </tr>
            </thead>
            <tbody>
                {% for audio in audio_files %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ audio.audio.name }}</td>
                    <td>
                        <audio id="audio-{{ audio.id }}" controls>
                            <source src="{{ audio.audio.url }}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </td>
                    <td>
                        <button class="details-btn" data-audio-id="{{ audio.id }}">View Details</button>
                        <form method="post" action="{% url 'delete_audio' audio.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete this file?');">
                                Delete
                            </button>
                        </form>
    
                    </td>
                    <td>
                        <div class="analysis-results" id="analysis-{{ audio.id }}">
                            <p><strong>Transcription:</strong> <span id="transcription-{{ audio.id }}"></span></p>
                            <p><strong>Keywords:</strong> <span id="keywords-{{ audio.id }}"></span></p>
                            <p><strong>Emotion:</strong> <span id="emotion-{{ audio.id }}"></span></p>
                            <p><strong>Pitch:</strong> <span id="pitch-{{ audio.id }}"></span></p>
                            <img id="pitch-plot-{{ audio.id }}" style="width: 300px; display: none;" />
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: red; text-align: center;">No audio file uploaded yet.</p>
        {% endif %}
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("audio").forEach(audioElement => {
            const audioId = audioElement.getAttribute("id").split("-")[1];
            let lastQueriedTime = -1; // Track last requested time to avoid redundant calls
            const queryInterval = 5; // Set interval to 5 seconds (adjust if needed)

            audioElement.addEventListener("timeupdate", function () {
                const currentTime = Math.floor(audioElement.currentTime);

                // Avoid frequent API calls (only call when new interval is reached)
                if (currentTime % queryInterval === 0 && currentTime !== lastQueriedTime) {
                    lastQueriedTime = currentTime; // Update last queried time

                    fetch(`/analyze_audio/${audioId}/?time=${currentTime}`, { method: "GET" })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                console.error("Error:", data.error);
                                return;
                            }
                            document.getElementById(`transcription-${audioId}`).innerText = 
                                data.transcript.map(t => t.text).join(" ") || "N/A";
                            document.getElementById(`keywords-${audioId}`).innerText = 
                                data.keywords?.join(", ") || "N/A";
                            document.getElementById(`emotion-${audioId}`).innerText = 
                                data.transcript.length > 0 ? data.transcript[0].emotion : "N/A";
                            document.getElementById(`pitch-${audioId}`).innerText = 
                                data.pitch_values.slice(0, 5).join(", ") + "...";

                            if (data.pitch_plot) {
                                const pitchPlotElement = document.getElementById(`pitch-plot-${audioId}`);
                                pitchPlotElement.src = `/${data.pitch_plot}`;
                                pitchPlotElement.style.display = "block";
                            }
                        })
                        .catch(error => console.error("Error:", error));
                }
            });
        });
    });
</script>


{% endblock %}
