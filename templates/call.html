{% extends "base.html" %}
{% load static %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" type="text/css" href="{% static 'css/call.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<div class="dashboard">
    <header class="dashboard-header">
        <h1 class="dashboard-title">CALL</h1>
        <li><a href="{% url 'logout' %}">Logout</a></li>
    </header>
    <div class="dashboard-grid">
        <div class="upload-section card">
            <div class="card-header">
                <i class="fas fa-cloud-upload-alt"></i>
                <h2>Upload Audio File</h2>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" class="upload-form">
                    {% csrf_token %}
                    <div class="form-group">
                        {{ form.as_p }}
                    </div>
                    <button type="submit" class="upload-btn">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                </form>
            </div>
        </div>
        <div class="audio-list card">
            <div class="card-header">
                <i class="fas fa-headphones"></i>
                <h2>Uploaded Audio Files</h2>
            </div>
            <div class="card-body">
                {% if audio_files %}
                <div class="table-container">
                    <table class="audio-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>File Name</th>
                                <th>Play</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for audio in audio_files %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td class="filename">
                                    <i class="fas fa-file-audio"></i>
                                    <span>{{ audio.audio.name }}</span>
                                </td>
                                <td>
                                    <div class="audio-player">
                                        <audio id="audio-{{ audio.id }}" controls>
                                            <source src="{{ audio.audio.url }}" type="audio/mpeg">
                                            Your browser does not support the audio element.
                                        </audio>
                                    </div>
                                </td>
                                <td class="action-buttons">
                                    <button class="details-btn" data-audio-id="{{ audio.id }}">
                                        <i class="fas fa-info-circle"></i> Details
                                    </button>
                                    <form method="post" action="{% url 'delete_audio' audio.id %}" class="delete-form">
                                        {% csrf_token %}
                                        <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete this file?');">
                                            <i class="fas fa-trash-alt"></i> Delete
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="no-audio-container">
                    <i class="fas fa-exclamation-circle"></i>
                    <p class="no-audio-message">No audio files uploaded yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Analysis Results Section -->
    <div class="analysis-section">
        <div class="card-header">
            <i class="fas fa-chart-line"></i>
            <h2>Analysis Results</h2>
        </div>
        <div class="results-container">
            {% if audio_files %}
                {% for audio in audio_files %}
                <div class="analysis-card" id="analysis-{{ audio.id }}">
                    <div class="analysis-header">
                        <h3>{{ audio.audio.name }}</h3>
                    </div>
                    <div class="analysis-body">
                        <div class="analysis-item">
                            <i class="fas fa-file-alt"></i>
                            <div class="analysis-content">
                                <h4>Transcription</h4>
                                <p id="transcription-{{ audio.id }}"></p>
                            </div>
                        </div>
                        <div class="analysis-item">
                            <i class="fas fa-key"></i>
                            <div class="analysis-content">
                                <h4>Sentiment</h4>
                                <p id="sentiment-{{ audio.id }}"></p>
                            </div>
                        </div>
                        <div class="analysis-item">
                            <i class="fas fa-smile"></i>
                            <div class="analysis-content">
                                <h4>Emotion</h4>
                                <p id="emotion-{{ audio.id }}"></p>
                            </div>
                        </div>
                        <div class="analysis-item">
                            <i class="fas fa-music"></i>
                            <div class="analysis-content">
                                <h4>Pitch</h4>
                                <p id="pitch-{{ audio.id }}"></p>
                                <p id="pitch-history-{{ audio.id }}"></p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-analysis-container">
                    <i class="fas fa-info-circle"></i>
                    <p>Upload an audio file to see analysis results.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("audio").forEach(audioElement => {
            const audioId = audioElement.getAttribute("id").split("-")[1];
            let lastQueriedTime = -1;
            const queryInterval = 3; // Fetch new data every 3 seconds

            let transcriptHistory = [];
            let emotionHistory = [];
            let sentimentHistory = [];
            let pitchHistory = []; // Store pitch values, "Hard" and "Low" labels
            let isHardFlagged = false; // Track if pitch was flagged as "Hard"
            let isLowFlagged = false;  // Track if pitch was flagged as "Low"

            audioElement.addEventListener("timeupdate", function () {
                const currentTime = Math.floor(audioElement.currentTime);

                if (currentTime % queryInterval === 0 && currentTime !== lastQueriedTime) {
                    lastQueriedTime = currentTime;

                    // ✅ Fetch Transcription
                    fetch(`/analyze_audio/${audioId}/?time=${currentTime}`, { method: "GET" })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                console.error("❌ Transcription Error:", data.error);
                                return;
                            }

                            let newText = data.transcript;
                            transcriptHistory.push(`<span class="highlight-new">${newText}</span>`);
                            document.getElementById(`transcription-${audioId}`).innerHTML = transcriptHistory.join(" ");

                            // ✅ Fetch Emotion & Sentiment Separately
                            fetch(`/analyze_text/?text=${encodeURIComponent(newText)}`, { method: "GET" })
                                .then(response => response.json())
                                .then(analysisData => {
                                    if (analysisData.error) {
                                        console.error("❌ Analysis Error:", analysisData.error);
                                        return;
                                    }

                                    let newEmotion = analysisData.emotion || "Neutral";
                                    emotionHistory.push(`<span class="highlight-new">${newEmotion}</span>`);
                                    document.getElementById(`emotion-${audioId}`).innerHTML = emotionHistory.join(", ");

                                    let newSentiment = analysisData.sentiment || "Neutral";
                                    sentimentHistory.push(`<span class="highlight-new">${newSentiment}</span>`);
                                    document.getElementById(`sentiment-${audioId}`).innerHTML = sentimentHistory.join(", ");
                                })
                                .catch(error => console.error("❌ Analysis Fetch error:", error));
                        })
                        .catch(error => console.error("❌ Fetch error:", error));

                    // ✅ Fetch Pitch Data
                    fetch(`/extract_pitch/${audioId}/?time=${currentTime}`, { method: "GET" })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                console.error("❌ Pitch Error:", data.error);
                                document.getElementById(`pitch-${audioId}`).innerText = "N/A";
                                return;
                            }

                            const currentPitch = data.avg_pitch;
                            pitchHistory.push(currentPitch); // Add current pitch to the history

                            // ✅ Check if current pitch is 60% greater or lesser than the previous one
                            if (pitchHistory.length > 1) {
                                const lastPitch = pitchHistory[pitchHistory.length - 2];
                                const pitchDifference = (currentPitch - lastPitch) / lastPitch;

                                if (pitchDifference > 0.6 && !isHardFlagged) {
                                    // If current pitch is more than 60% greater than the last pitch, display "Hard"
                                    pitchHistory.push("Hard"); // Append "Hard" to history
                                    document.getElementById(`pitch-${audioId}`).innerText = `(avg: ${currentPitch}Hz) - Hard`;
                                    isHardFlagged = true; // Mark as hard
                                    isLowFlagged = false; // Reset Low flag
                                } else if (pitchDifference < -0.6 && !isLowFlagged) {
                                    // If pitch goes down by more than 60%, display "Low"
                                    pitchHistory.push("Low"); // Append "Low" to history
                                    document.getElementById(`pitch-${audioId}`).innerText = `(avg: ${currentPitch}Hz) - Low`;
                                    isLowFlagged = true; // Mark as low
                                    isHardFlagged = false; // Reset Hard flag
                                } else if (!isHardFlagged && !isLowFlagged) {
                                    document.getElementById(`pitch-${audioId}`).innerText = `(avg: ${currentPitch}Hz)`;
                                }
                            } else {
                                document.getElementById(`pitch-${audioId}`).innerText = `(avg: ${currentPitch}Hz)`;
                            }

                            // Display full pitch history, join all values with commas
                            const pitchHistoryList = pitchHistory.join(", ");
                            document.getElementById(`pitch-history-${audioId}`).innerHTML = `Pitch History: ${pitchHistoryList}`;

                        })
                        .catch(error => console.error("❌ Fetch error:", error));
                }
            });
        });
    });
</script>




{% endblock %}