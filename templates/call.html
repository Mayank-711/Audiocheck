{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="dashboard">
    <h1>Dashboard</h1>
    
    <li><a href="{% url 'logout' %}">Logout</a></li>

    <div class="upload-section">
        <h2>Upload Audio File</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Upload</button>
        </form>
    </div>

    <div class="audio-list">
        <h2>Uploaded Audio Files</h2>

        {% if audio_files %}
        <table border="1">
            <thead>
                <tr>
                    <th>#</th>
                    <th>File Name</th>
                    <th>Play</th>
                    <th>Actions</th>
                    <th>Analysis</th>
                </tr>
            </thead>
            <tbody>
                {% for audio in audio_files %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ audio.audio.name }}</td>
                    <td>
                        <audio id="audio-{{ audio.id }}" controls>
                            <source src="{{ audio.audio.url }}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </td>
                    <td>
                        <button class="details-btn" data-audio-id="{{ audio.id }}">View Details</button>
                        <form method="post" action="{% url 'delete_audio' audio.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete this file?');">
                                Delete
                            </button>
                        </form>
    
                    </td>
                    <td>
                        <div class="analysis-results" id="analysis-{{ audio.id }}">
                            <p><strong>Transcription:</strong> <span id="transcription-{{ audio.id }}"></span></p>
                            <p><strong>Keywords:</strong> <span id="keywords-{{ audio.id }}"></span></p>
                            <p><strong>Emotion:</strong> <span id="emotion-{{ audio.id }}"></span></p>
                            <p><strong>Pitch:</strong> <span id="pitch-{{ audio.id }}"></span></p>
                            <img id="pitch-plot-{{ audio.id }}" style="width: 300px; display: none;" />
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: red; text-align: center;">No audio file uploaded yet.</p>
        {% endif %}
    </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("audio").forEach(audioElement => {
        const audioId = audioElement.getAttribute("id").split("-")[1];
        let lastQueriedTime = -1; // Prevent duplicate API calls
        const queryInterval = 5; // Fetch new transcription every 5 seconds
        let transcriptHistory = []; // Store past transcriptions

        audioElement.addEventListener("timeupdate", function () {
            const currentTime = Math.floor(audioElement.currentTime);

            // ✅ Fetch new transcript every 5 seconds
            if (currentTime % queryInterval === 0 && currentTime !== lastQueriedTime) {
                lastQueriedTime = currentTime;

                fetch(`/analyze_audio/${audioId}/?time=${currentTime}`, { method: "GET" })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error("❌ Error:", data.error);
                            return;
                        }

                        // ✅ Store transcript and highlight the latest chunk
                        let newText = data.transcript || "No speech detected";
                        transcriptHistory.push(`<span style="background-color: yellow;">${newText}</span>`);

                        // ✅ Display the entire transcript history
                        document.getElementById(`transcription-${audioId}`).innerHTML = transcriptHistory.join(" ");

                        // ✅ Update other elements safely
                        document.getElementById(`keywords-${audioId}`).innerText = data.keywords ? data.keywords.join(", ") : "N/A";
                        document.getElementById(`emotion-${audioId}`).innerText = data.emotion || "N/A";
                        document.getElementById(`pitch-${audioId}`).innerText = data.pitch_values ? data.pitch_values.slice(0, 5).join(", ") + "..." : "N/A";

                        // ✅ Show pitch plot if available
                        if (data.pitch_plot) {
                            const pitchPlotElement = document.getElementById(`pitch-plot-${audioId}`);
                            pitchPlotElement.src = `/${data.pitch_plot}`;
                            pitchPlotElement.style.display = "block";
                        }

                        // ✅ Remove highlighting after 3 seconds
                        setTimeout(() => {
                            transcriptHistory[transcriptHistory.length - 1] = newText;
                            document.getElementById(`transcription-${audioId}`).innerHTML = transcriptHistory.join(" ");
                        }, 3000);
                    })
                    .catch(error => console.error("❌ Fetch error:", error));
            }
        });
    });
});

</script>


{% endblock %}
